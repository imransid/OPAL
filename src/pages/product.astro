---
import Layout from '../layouts/Layout.astro';
import '../../assets/scss/astro-ecommerce.scss';
import Navbar from '../components/navbar';
import Footer from '../components/footer';
import ProductPageFirebase from '../components/data/ProductPageFirebase';
import { getProductServer } from '../lib/firestore-server';
import { fullUrl } from '../lib/seo';

const id = Astro.url.searchParams.get('id') ?? '';
const product = id ? await getProductServer(id) : null;

const title = product
	? `${product.title} — OPAL${product.brand ? ` | ${product.brand}` : ''}`
	: 'Product — OPAL';
const description = product
	? (product.shortDescription ||
			product.description ||
			`Buy ${product.title} at OPAL. Quality product, secure checkout, fast delivery.`).slice(0, 160)
	: 'Shop quality products at OPAL.';
const image = product?.thumb_src || product?.images?.[0]?.src || '/images/opal1.jpg';
const site = Astro.site?.href || 'https://opal.example.com';

// Product JSON-LD for rich snippets
const productJsonLd = product
	? {
			'@context': 'https://schema.org',
			'@type': 'Product',
			name: product.title,
			description: description,
			image: image.startsWith('http') ? image : fullUrl(image, site),
			...(product.price != null && {
				offers: {
					'@type': 'Offer',
					price: product.discountPrice ?? product.price,
					priceCurrency: product.currency ?? 'BDT',
					availability: product.stock !== false ? 'https://schema.org/InStock' : 'https://schema.org/OutOfStock',
				},
			}),
			...(product.brand && { brand: { '@type': 'Brand', name: product.brand } }),
		}
	: null;
---

<Layout
	title={title}
	description={description}
	image={image}
	imageAlt={product?.thumb_alt ?? product?.title ?? 'Product'}
	canonical={id && product ? `${site}/product?id=${id}` : undefined}
	noindex={!product}
	structuredData={productJsonLd}
>
	<main>
		<Navbar client:load />
		<ProductPageFirebase client:load productId={id} />
		<Footer />
	</main>
</Layout>
